## Gaussian Pyramid and Laplacian Pyramid
我们先简单回顾一下两个金字塔的定义。
### **高斯金字塔 (Gaussian Pyramid)**
**作用**：通过逐层降采样（缩小）生成图像的多尺度表示，每层图像是前一层的模糊和下采样结果。  
**构建方法**：  
1. 对原始图像应用高斯模糊（平滑去噪）。  
2. 降采样（如尺寸减半）。  
3. 重复上述步骤，形成金字塔结构。  

**特点**：  
- 保留低频信息（整体结构），丢失高频细节。  
- 可用于图像缩放、多分辨率分析。  
![alt text](<屏幕截图 2025-04-26 113358.png>)

---

### **拉普拉斯金字塔 (Laplacian Pyramid)**
**作用**：通过高斯金字塔的差值生成，保存图像的高频细节（边缘、纹理）。  
**构建方法**：  
1. 计算高斯金字塔的每一层与其上一层的上采样结果的差值：  
   \[
   L_i = G_i - \text{Upsample}(G_{i+1})
   \]  
2. 最顶层保留高斯金字塔的顶层（最低频信息）。

**特点**：  
- 每层包含对应尺度的高频细节。  
- 可用于图像重建、融合（如无缝拼接）。  
![alt text](<屏幕截图 2025-04-26 113415.png>)

## 1. Image Reconstruction
### 方法简述
**目标**：给定拉普拉斯金字塔（包含高斯金字塔的顶层），重建原始图像。  
**步骤**：  
1. **输入**：  
   - 拉普拉斯金字塔层级：\( \{L_0, L_1, ..., L_{k-1}\} \)  
   - 高斯金字塔顶层：\( G_k \)（最低分辨率图像）。  

2. **重建过程**：  
   - 从顶层 \( G_k \) 开始，逐层向上扩展（upsample）并与拉普拉斯金字塔的对应层相加：  
     \[
     G_{i} = \text{Upsample}(G_{i+1}) + L_{i}, \quad i = k-1, k-2, ..., 0
     \]  
   - **Upsample 操作**：使用插值（我使用的是双线性插值）将图像放大到上一层的尺寸。  
   - 最终 \( G_0 \) 即为重建的原始图像。  

**核心思路**：  
- 拉普拉斯金字塔的每一层保存了不同频带的细节信息，重建时通过逐层叠加恢复完整图像。  
- 高斯金字塔的顶层 \( G_k \) 是图像的低频近似，而拉普拉斯层 \( L_i \) 补充高频细节。
![alt text](<屏幕截图 2025-04-26 113439.png>)

### 踩过的坑
1. **重建图片亮度过高**
**现象描述**：初版执行任务一“image reconstruction”时，得到的图片亮度过高。<br>
**问题分析**：经过检查发现是因为我们在进行图像处理的时候，为了避免卷积等操作的溢出，选择先将图像归一化至 `[0, 1]`，而在计算 laplacian pyramid 时，可能得到负值，而这个负值在还原回 `[0, 255]` 时被迫变成了 0，因此导致最后亮度偏高。<br>  
**解决办法**：由于下采样再上采样之后的像素值并不会差太多，所以我们可以认为 laplacian pyramid 的像素值会落在 `[-0.5, 0.5]` 这个区间。
因此我们在保存的时候就可以先将其加上一个 offset 0.5，然后再保存；要用的时候则是加载完减去 offset，这样就成功保留了负值。
<br>
2. **重建图片局部偏暗**
**现象描述**：修改之后如果取 gaussian pyramid top 作为重建的 top 则能成功重建，但如果选择 top 为 laplacian pyramid 的 top，则重建的图片有一部分亮度过低，可但理论上二者是同一个东西，不应该有所差异。<br>
**问题分析**：经过检查发现是因为我们在改进 laplacian 保存方法时，我们是假设 laplacian pyramid 的像素值会落在 `[-0.5, 0.5]` 这个区间，
而这个假设的前提是 laplacian pyramid 是由相邻 gaussian pyramid level 作差得到的，可是 laplacian pyramid top 是直接复制 gaussian pyramid top，
因此完全可能超出我们假设的区间。<br>
**解决办法**：我们只需要分类讨论，在保存 laplacian pyramid top 时正常报错，加载时正常加载就行。

---

## 2. Image Blending
### 方法简述
**目标**：给定两幅图像 \( I_A \) 和 \( I_B \)，以及掩膜 \( M \)，实现无缝融合。  
**步骤**：  
1. **构建金字塔**：  
   - 对 \( I_A \) 和 \( I_B \) 分别构建拉普拉斯金字塔：\( \{L^A_0, ..., L^A_k\} \)、\( \{L^B_0, ..., L^B_k\} \)。  
   - 对掩膜 \( M \) 构建高斯金字塔：\( \{G^M_0, ..., G^M_k\} \)（掩膜需归一化到 [0,1]）。  

2. **金字塔融合**：  
   - 对每一层拉普拉斯金字塔，按掩膜的权重混合：  
     \[
     L^{\text{blend}}_i = G^M_i \cdot L^A_i + (1 - G^M_i) \cdot L^B_i
     \]  
   - **掩膜作用**：在低频层（高层）平滑过渡，高频层（低层）保留边缘细节。  

3. **重建融合图像**：  
   - 从混合后的拉普拉斯金字塔 \( \{L^{\text{blend}}_0, ..., L^{\text{blend}}_k\} \) 和顶层高斯 \( G_k \)（通常取 \( I_A \) 或 \( I_B \) 的顶层），按 **Task 1** 的方法重建最终图像。  

**核心思路**：  
- **多频带融合**：不同金字塔层对应不同频率的细节，避免直接混合导致的边缘伪影。  
- **掩膜平滑性**：高斯金字塔确保掩膜过渡平滑（如羽化边缘），避免突兀的接缝。  
![alt text](<屏幕截图 2025-04-26 113458.png>)

### 踩过的坑
前面的函数写得比较 robust 了，按照思路写没出什么岔子。